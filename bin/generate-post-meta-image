#!/bin/sh -e
#
# Example:
#
# BG="#222222" bin/generate-multiline-post-meta-image "First line" "Second line" out.png

res=2160x1080

tmp=$(mktemp -d)

# generate background
if [[ "$BG" == "" ]]; then
  BG="#2421AB"
  convert -size $res xc:$BG $tmp/bg.png
else
  convert $2 -resize $res^ $tmp/bg-uncropped.png
  convert $tmp/bg-uncropped.png -gravity center -crop $res+0+0 -fill black -colorize 40% $tmp/bg.png
fi

# generate header
convert -size $res xc:"#00000000" \
  -pointsize 100 -fill white -draw 'text 100,160 "Blog Post" ' \
  $tmp/text-top.png

if [[ "$#" -eq "2" ]]; then
  files="$tmp/text-top-line.png"
  top_line="$1"
  out="$2"

  # generate single lined text
  convert -size $res xc:"#00000000" \
    -font ./src/fonts/acta-headline-extra-bold.woff \
    -pointsize 165 -fill white -draw "text 100,925 '$top_line' " \
    $tmp/text-top-line.png
else
  files="$tmp/text-top-line.png $tmp/text-bottom-line.png"
  top_line="$1"
  bottom_line="$2"
  out="$3"

  # generate double lined text
  convert -size $res xc:"#00000000" \
    -font ./src/fonts/acta-headline-extra-bold.woff \
    -pointsize 165 -fill white -draw "text 100,750 '$top_line' " \
    $tmp/text-top-line.png

  convert -size $res xc:"#00000000" \
    -font ./src/fonts/acta-headline-extra-bold.woff \
    -pointsize 165 -fill white -draw "text 100,925 '$bottom_line' " \
    $tmp/text-bottom-line.png
fi

cmd="convert -page +0+0 $tmp/bg.png -page +0+0 static/script-assets/blog-post-top.png"

for file in $files; do
  cmd="$cmd -page +0+0 $file"
done

cmd="$cmd -layers merge +repage $out"

`$cmd`

# # Optimize image for smaller footprint
bundler exec image_optim $out
